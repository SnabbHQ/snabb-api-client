{"version":3,"sources":["ApiRequest.js"],"names":[],"mappings":"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","file":"ApiRequest-compiled.js","sourcesContent":["'use strict';\n\nconst _ = require('lodash');\nconst util = require('util');\nconst async = require('async');\nconst events = require('events');\nconst rest = require('restling');\nconst nconf = require('nconf');\nconst Q = require('q');\n\nconst API_SANDBOX_URI = 'https://sandbox-api.snabb.com/v1/';\nconst API_PRODUCTION_URI = 'https://api.snabb.com/v1/';\nconst OAUTH_URI = 'https://login.snabb.com/oauth/v2/token';\n\nconst REFRESH_SECONDS_BEFORE_EXPIRY = 10;\n\nlet access_token;\nlet expires_at;\n\nlet log = function () {};\n\nfunction setTimeout_ (fn, delay) {\n  const maxDelay = Math.pow(2,31)-1;\n\n  if (delay > maxDelay) {\n    var args = arguments;\n    args[1] -= maxDelay;\n\n    return setTimeout(function () {\n      setTimeout_.apply(undefined, args);\n    }, maxDelay);\n  }\n\n  return setTimeout.apply(undefined, arguments);\n}\n\nfunction refresh(expiresIn) {\n  const refreshTimeMs = (expiresIn - REFRESH_SECONDS_BEFORE_EXPIRY)*1000;\n\n  setTimeout_(function() {\n    log('Snabb API token expires in '+REFRESH_SECONDS_BEFORE_EXPIRY+' seconds. Refreshing.');\n    getToken();\n  }, refreshTimeMs);\n}\n\nfunction getToken(options) {\n  options = options || {};\n\n  // Setup logging based on the config\n  log = (nconf.get('snabb_api_debug') ? log.bind(console) : function () {});\n\n  if (options.accessToken) {\n    access_token = options.accessToken;\n  }\n  if (access_token) {\n    if (expires_at > Date.now() + 20000) {\n      return Q(access_token);\n    }\n  }\n\n  log('Getting Snabb API token.');\n  let scope = nconf.get('snabb_api_scope');\n\n  return rest.post(OAUTH_URI, {\n    multipart: true,\n    data: {\n      client_secret: nconf.get('snabb_api_client_secret'),\n      client_id: nconf.get('snabb_api_client_id'),\n      server_token: nconf.get('snabb_api_server_token'),\n      grant_type: 'client_credentials',\n      scope: scope ? scope : 'delivery_sandbox'\n    }\n  }).then(function(result) {\n    log('getToken result', result && result.data ? result.data : null);\n    if (result.response.statusCode == 200) {\n      log('Authenticated and received Snabb API access token.');\n      access_token = result.data.access_token;\n      let expiresInSeconds = parseInt(result.data.expires_in, 10);\n\n      expires_at = Date.now() + expiresInSeconds * 1000;\n\n      // kick off token refresh process\n      refresh(expiresInSeconds);\n\n      return access_token;\n    } else {\n      console.error('Snabb API authentication failed', result.response.raw);\n      throw new Error(result.response);\n    }\n  }, function(error) {\n    console.error('Snabb API authentication error', error.response.raw);\n    throw new Error(error.response.raw);\n  });\n}\n\nfunction getUrl(path) {\n  const sandbox = nconf.get('snabb_api_sandbox');\n  return (sandbox ? API_SANDBOX_URI : API_PRODUCTION_URI) + (path||'');\n}\n\nfunction call(path, options) {\n  return getToken(options)\n  .then(function(accessToken) {\n    if (!options.accessToken) options.accessToken = accessToken;\n    log('API ' + options.method + ' ' +  getUrl(path), (options.data||''));\n    return rest.request(getUrl(path), options);\n  }).then(function(result) {\n    try {\n      if (typeof result.data == 'string') result.data = JSON.parse(result.data);\n    }\n    catch (e) {\n    }\n\n    if (options.method == 'GET') {\n      if (result.response.statusCode == 200) {\n        return result.data;\n      }\n    }\n    if (options.method == 'POST') {\n      if (result.response.statusCode == 204) {\n        return true;\n      }\n    }\n    return result;\n  }, function(error) {\n    console.error('RESULT', error.data);\n    return error;\n  });\n}\n\nmodule.exports = {\n  'getToken': getToken,\n  'post': function (path, data) {\n    let options = {\n      method: 'POST',\n      headers: {'content-type': 'application/json'},\n      data: JSON.stringify(data)\n    };\n\n    return call(path, options);\n  },\n  'put': function (path, data) {\n    let options = {\n      method: 'PUT',\n      headers: {'content-type': 'application/json'},\n      data: JSON.stringify(data)\n    };\n\n    return call(path, options);\n  },\n  'get': function (path) {\n    let options = {\n      method: 'GET'\n    };\n    return call(path, options);\n  }\n};\n"]}